{% extends 'base.html' %}

{% block title %}{{ product.name }} - –ú–∞–≥–∞–∑–∏–Ω{% endblock %}

{% block content %}
<div class="product-detail">
    <div class="product-detail-image">
        {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% else %}
            <div class="product-image-placeholder-large">üì¶</div>
        {% endif %}
    </div>
    <div class="product-detail-info">
        <h1>{{ product.name }}</h1>
        <p class="product-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ product.category.name }}</p>
        <p class="product-seller">–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ product.seller.username }}</p>
        <div class="product-rating-large">
            ‚≠ê {{ product.average_rating|floatformat:1 }} ({{ product.reviews.count }} –æ—Ç–∑—ã–≤–æ–≤)
        </div>
        <p class="product-price-large">{{ product.price }} ‚ÇΩ</p>
        <p class="product-stock-large {% if product.stock == 0 %}stock-zero{% elif product.stock < 10 %}stock-low{% endif %}">
            –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }} —à—Ç.
            {% if product.stock == 0 %}
                <span class="stock-badge out-of-stock">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
            {% elif product.stock < 10 %}
                <span class="stock-badge low-stock">‚ö†Ô∏è –ú–∞–ª–æ —Ç–æ–≤–∞—Ä–∞</span>
            {% endif %}
        </p>
        <p class="product-description">{{ product.description }}</p>
        
        {% if user.is_authenticated and user.user_type == 'buyer' %}
            {% if product.stock > 0 %}
            <div class="product-actions-large">
                <input type="number" id="quantity" value="1" min="1" max="{{ product.stock }}" class="quantity-input">
                <button onclick="addToCart({{ product.id }})" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            </div>
            {% else %}
            <div class="product-actions-large">
                <button class="btn-primary btn-disabled" disabled>–¢–æ–≤–∞—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</button>
            </div>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="reviews-section">
    <h2>–û—Ç–∑—ã–≤—ã</h2>
    
    {% if user.is_authenticated and user.user_type == 'buyer' %}
    <div class="review-form">
        <h3>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
        <form id="reviewForm">
            {% csrf_token %}
            <div class="form-group">
                <label>–û—Ü–µ–Ω–∫–∞</label>
                <select id="rating" class="form-input">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê</option>
                    <option value="2">‚≠ê‚≠ê</option>
                    <option value="1">‚≠ê</option>
                </select>
            </div>
            <div class="form-group">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" rows="4" class="form-input" required></textarea>
            </div>
            <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
    </div>
    {% endif %}
    
    <div class="reviews-list">
        {% for review in reviews %}
        <div class="review-card">
            <div class="review-header">
                <strong>{{ review.user.username }}</strong>
                <span class="review-rating">{{ review.rating }}‚≠ê</span>
            </div>
            <p class="review-date">{{ review.created_at|date:"d.m.Y H:i" }}</p>
            <p class="review-comment">{{ review.comment }}</p>
        </div>
        {% empty %}
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function addToCart(productId) {
    const quantity = document.getElementById('quantity').value;
    
    fetch('/api/cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: parseInt(quantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!');
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
    });
}

document.getElementById('reviewForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const rating = document.getElementById('rating').value;
    const comment = document.getElementById('comment').value;
    
    fetch('/api/reviews/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            product: {{ product.id }},
            rating: parseInt(rating),
            comment: comment
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞');
            });
        }
        return response.json();
    })
    .then(data => {
        alert('–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω!');
        location.reload();
    })
    .catch(error => {
        alert(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞');
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

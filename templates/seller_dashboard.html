{% extends 'base.html' %}

{% block title %}–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞ - –ú–∞–≥–∞–∑–∏–Ω{% endblock %}

{% block content %}
<div class="seller-dashboard">
    <h1>–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-info">
                <h3>{{ stats.total_products }}</h3>
                <p>–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìã</div>
            <div class="stat-info">
                <h3>{{ stats.total_orders }}</h3>
                <p>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-info">
                <h3>{{ stats.active_orders }}</h3>
                <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <h3>{{ stats.completed_orders }}</h3>
                <p>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
            </div>
        </div>
        
        <div class="stat-card stat-card-highlight">
            <div class="stat-icon">üí∞</div>
            <div class="stat-info">
                <h3>{{ stats.total_revenue|floatformat:2 }} ‚ÇΩ</h3>
                <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-info">
                <h3>{{ stats.pending_revenue|floatformat:2 }} ‚ÇΩ</h3>
                <p>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-info">
                <h3>{{ stats.total_stock }}</h3>
                <p>–¢–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üíµ</div>
            <div class="stat-info">
                <h3>{{ stats.avg_price|floatformat:2 }} ‚ÇΩ</h3>
                <p>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</p>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã -->
    {% if stats.popular_products %}
    <div class="dashboard-section">
        <h2>üìà –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h2>
        <div class="popular-products">
            {% for product in stats.popular_products %}
            <div class="popular-product-item">
                <span class="product-name">{{ product.name }}</span>
                <span class="product-orders">{{ product.orders_count }} –∑–∞–∫–∞–∑–æ–≤</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    {% if stats.status_stats %}
    <div class="dashboard-section">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
        <div class="status-stats">
            {% for status_name, count in stats.status_stats.items %}
            <div class="status-stat-item">
                <span class="status-name">{{ status_name }}</span>
                <span class="status-count">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="dashboard-section">
        <div class="section-header">
            <h2>–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</h2>
            <button onclick="showAddProductForm()" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </div>
        
        <div id="addProductForm" class="product-form" style="display: none;">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
            <form id="productForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="productDescription" class="form-input" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞</label>
                    <input type="number" id="productPrice" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="productStock" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="productCategory" class="form-input" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                    <input type="file" id="productImage" class="form-input" accept="image/*">
                </div>
                <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button type="button" onclick="hideAddProductForm()" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
        
        <div class="products-list">
            {% for product in products %}
            <div class="product-item">
                <h3>{{ product.name }}</h3>
                <p>–¶–µ–Ω–∞: {{ product.price }} ‚ÇΩ</p>
                <p class="{% if product.stock == 0 %}stock-zero{% elif product.stock < 10 %}stock-low{% endif %}">
                    –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }} —à—Ç.
                    {% if product.stock == 0 %}
                        <span class="stock-warning">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                    {% elif product.stock < 10 %}
                        <span class="stock-warning">‚ö†Ô∏è –ú–∞–ª–æ</span>
                    {% endif %}
                </p>
                <p>–†–µ–π—Ç–∏–Ω–≥: ‚≠ê {{ product.average_rating|floatformat:1 }}</p>
                
                <!-- –§–æ—Ä–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
                <form method="post" action="{% url 'add_product_stock' product.id %}" class="add-stock-form">
                    {% csrf_token %}
                    <div class="stock-form-group">
                        <input type="number" name="quantity" min="1" max="10000" 
                               placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="stock-input" required>
                        <button type="submit" class="btn-primary btn-small">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>
            {% empty %}
            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
            {% endfor %}
        </div>
    </div>

    <div class="dashboard-section">
        <h2>‚è≥ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
        <div class="orders-list">
            {% for order in active_orders %}
            <div class="order-card">
                <div class="order-header">
                    <h3>–ó–∞–∫–∞–∑ #{{ order.id }}</h3>
                    <select onchange="updateOrderStatus({{ order.id }}, this.value)" class="status-select">
                        <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</option>
                        <option value="accepted" {% if order.status == 'accepted' %}selected{% endif %}>–ü—Ä–∏–Ω—è—Ç</option>
                        <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                        <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                        <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                        <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω</option>
                    </select>
                </div>
                <div class="order-info">
                    <p><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</strong> {{ order.buyer.username }}</p>
                    {% if order.buyer.phone %}
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ order.buyer.phone }}</p>
                    {% endif %}
                    {% if order.buyer.address %}
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ order.buyer.address }}</p>
                    {% endif %}
                    <p><strong>–¢–æ–≤–∞—Ä:</strong> {{ order.product.name }}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> {{ order.quantity }}</p>
                    <p><strong>–°—É–º–º–∞:</strong> {{ order.total_price }} ‚ÇΩ</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</strong> {{ order.created_at|date:"d.m.Y H:i" }}</p>
                </div>
            </div>
            {% empty %}
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
            {% endfor %}
        </div>
    </div>

    <div class="dashboard-section">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
        <div class="orders-list">
            {% for order in history_orders %}
            <div class="order-card order-history">
                <div class="order-header">
                    <h3>–ó–∞–∫–∞–∑ #{{ order.id }}</h3>
                    <span class="order-status status-{{ order.status }}">{{ order.get_status_display }}</span>
                </div>
                <div class="order-info">
                    <p><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å:</strong> {{ order.buyer.username }}</p>
                    <p><strong>–¢–æ–≤–∞—Ä:</strong> {{ order.product.name }}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> {{ order.quantity }}</p>
                    <p><strong>–°—É–º–º–∞:</strong> {{ order.total_price }} ‚ÇΩ</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</strong> {{ order.created_at|date:"d.m.Y H:i" }}</p>
                    {% if order.is_received %}
                    <p class="order-completed">‚úì –ü–æ–ª—É—á–µ–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º {{ order.updated_at|date:"d.m.Y H:i" }}</p>
                    {% elif order.status == 'cancelled' %}
                    <p class="order-cancelled">‚úó –û—Ç–º–µ–Ω—ë–Ω {{ order.updated_at|date:"d.m.Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
fetch('/api/categories/')
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('productCategory');
        data.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
    });

function showAddProductForm() {
    document.getElementById('addProductForm').style.display = 'block';
}

function hideAddProductForm() {
    document.getElementById('addProductForm').style.display = 'none';
}

document.getElementById('productForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('name', document.getElementById('productName').value);
    formData.append('description', document.getElementById('productDescription').value);
    formData.append('price', document.getElementById('productPrice').value);
    formData.append('stock', document.getElementById('productStock').value);
    formData.append('category', document.getElementById('productCategory').value);
    
    const imageFile = document.getElementById('productImage').files[0];
    if (imageFile) {
        formData.append('image', imageFile);
    }
    
    fetch('/api/products/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
        location.reload();
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
    });
});

function updateOrderStatus(orderId, status) {
    fetch(`/api/orders/${orderId}/update_status/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        alert('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
